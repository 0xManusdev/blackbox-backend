// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
    provider = "prisma-client-js"
    output   = "../node_modules/.prisma/client"
}

datasource db {
    provider = "postgresql"
}

// Predefined airport zones
enum Zone {
    TERMINAL_1
    TERMINAL_2
    PORTES_EMBARQUEMENT
    ZONE_DOUANES
    PARKING
    HALL_ARRIVEE
    HALL_DEPART
    ZONE_TRANSIT
    AUTRE
}

model Report {
    id                Int      @id @default(autoincrement())
    
    // Form fields
    zone              Zone
    customZone        String?  @map("custom_zone") // For "AUTRE" option
    incidentTime      String   @map("incident_time") @db.VarChar(10) // "HH:MM" format
    description       String   // Original description from form
    
    // AI processed fields
    anonymizedContent String   @map("anonymized_content")
    category          String   @db.VarChar(100)
    severity          String   @db.VarChar(50)
    aiAnalysis        String   @map("ai_analysis")
    
    // Blockchain proof
    contentHash       String   @map("content_hash") @db.VarChar(66)
    blockchainTxHash  String   @map("blockchain_tx_hash") @db.VarChar(66)
    
    // Attachments (stored as Supabase URLs)
    attachments       String[] @default([])
    
    // Admin management
    status            String   @default("pending") @db.VarChar(50) // pending, resolved, closed
    resolvedBy        Int?     @map("resolved_by")
    resolvedAt        DateTime? @map("resolved_at")
    
    createdAt         DateTime @default(now()) @map("created_at")

    admin             Admin?   @relation(fields: [resolvedBy], references: [id])

    @@map("reports")
}

model Admin {
    id        Int      @id @default(autoincrement())
    firstName String   @map("first_name") @db.VarChar(100)
    lastName  String   @map("last_name") @db.VarChar(100)
    email     String   @unique @db.VarChar(255)
    password  String   @db.VarChar(255) // Bcrypt hashed
    position  String   @db.VarChar(100)
    createdAt DateTime @default(now()) @map("created_at")
    updatedAt DateTime @updatedAt @map("updated_at")
    
    reports   Report[]
    auditLogs AuditLog[]

    @@map("admins")
}

model AuditLog {
    id          Int      @id @default(autoincrement())
    adminId     Int      @map("admin_id")
    action      String   @db.VarChar(255) // e.g., "DELETE /api/reports/123"
    method      String   @db.VarChar(10)  // POST, PUT, DELETE
    endpoint    String   @db.VarChar(500)
    params      String?  @db.Text         // JSON string of request params/body
    ipAddress   String   @map("ip_address") @db.VarChar(50)
    userAgent   String   @map("user_agent") @db.Text
    createdAt   DateTime @default(now()) @map("created_at")
    
    admin       Admin    @relation(fields: [adminId], references: [id])

    @@map("audit_logs")
}
